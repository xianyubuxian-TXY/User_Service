# ============================================================
# Docker Compose 版本声明
# ============================================================
# 3.8 是较新的稳定版本，支持 healthcheck 的 condition 语法
version: '3.8'

services:
  # ==========================================================
  # MySQL 数据库服务
  # ==========================================================
  mysql:
    image: mysql:8.0                          # 使用官方 MySQL 8.0 镜像
    container_name: user-service-mysql        # 容器名称（方便识别）
    environment:
      MYSQL_ROOT_PASSWORD: root123            # root 用户密码
      MYSQL_DATABASE: user_service            # 启动时自动创建的数据库
    ports:
      - "3307:3306"                           # 主机端口:容器端口，允许外部连接
    volumes:
      - mysql_data:/var/lib/mysql             # 数据持久化到命名卷
      - ./scripts/init_db.sql:/docker-entrypoint-initdb.d/init.sql:ro
        # ↑ 初始化脚本，首次启动时自动执行（:ro = 只读挂载）
    networks:
      - user-network                          # 加入自定义网络
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
        # ↑ 健康检查命令：用 mysqladmin ping 测试连接
      interval: 10s                           # 每 10 秒检查一次
      timeout: 5s                             # 超时时间
      retries: 5                              # 连续失败 5 次才判定不健康

  # ==========================================================
  # Redis 缓存服务
  # ==========================================================
  redis:
    image: redis:7-alpine                     # alpine 版本更小（~30MB）
    container_name: user-service-redis
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data                      # 持久化 RDB/AOF 文件
    command: redis-server --appendonly yes    # 启用 AOF 持久化
      # ↑ 覆盖默认启动命令，保证数据不丢失
    networks:
      - user-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]      # PONG 表示健康
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================
  # 用户服务实例 1
  # ==========================================================
  user-service-1:
    build:
      context: .                              # 构建上下文为当前目录
      dockerfile: deploy/docker/Dockerfile    # Dockerfile 路径
    container_name: user-service-1
    depends_on:
      # ↓ 依赖的服务必须健康才启动（避免连接失败）
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - CONFIG_PATH=/app/configs/config.docker.yaml
        # ↑ 告诉应用配置文件位置
      - MYSQL_HOST=mysql                      # 用容器名作为主机名
      - REDIS_HOST=redis
    ports:
      - "50051:50051"                         # gRPC 端口映射
    volumes:
      - ./configs:/app/configs:ro             # 挂载配置目录（只读）
      - ./logs:/app/logs                      # 挂载日志目录（可写）
    networks:
      - user-network


# ==============================================================
# 命名卷（Docker 管理的持久化存储）
# ==============================================================
volumes:
  mysql_data:     # MySQL 数据
  redis_data:     # Redis 数据

# ==============================================================
# 自定义网络
# ==============================================================
networks:
  user-network:
    driver: bridge    # 桥接网络，容器间可通过容器名互访