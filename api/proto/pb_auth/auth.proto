// 版本声明：使用protobuf3语法
syntax = "proto3";

package pb_auth;

import "google/protobuf/timestamp.proto";
import "pb_common/result.proto";

// ==================== 枚举定义 ====================

// 短信验证码使用场景
enum SmsScene {
    SMS_SCENE_UNKNOWN = 0;       // 未知场景（默认值，禁止业务使用）
    SMS_SCENE_REGISTER = 1;      // 注册场景
    SMS_SCENE_LOGIN = 2;         // 登录场景
    SMS_SCENE_RESET_PASSWORD = 3;// 重置密码
    SMS_SCENE_DELETE_USER = 4;   // 注销账号
}

// 用户角色枚举（新增）
enum UserRole {
    USER_ROLE_USER = 0;          // 普通用户（默认）
    USER_ROLE_ADMIN = 1;         // 管理员
    USER_ROLE_SUPER_ADMIN = 2;   // 超级管理员
}

// ==================== 通用消息体定义 ====================

// 用户核心信息体
message UserInfo {
    string id = 1;                              // 用户UUID
    string mobile = 2;                          // 手机号
    string display_name = 3;                    // 昵称
    UserRole role = 4;                          // 用户角色（改为枚举类型）
    bool disabled = 5;                          // 是否禁用
    google.protobuf.Timestamp created_at = 6;   // 创建时间
}

// JWT双令牌对
message TokenPair {
    string access_token = 1;
    string refresh_token = 2;
    int64 expires_in = 3;     // access_token过期时间（秒）
}

// ==================== 短信验证码接口 ====================

message SendVerifyCodeRequest {
    string mobile = 1;
    SmsScene scene = 2;
}

message SendVerifyCodeResponse {
    pb_common.Result result = 1;
    int32 retry_after = 2;        // 重发冷却时间（秒）
}

// ==================== 注册接口 ====================

message RegisterRequest {
    string mobile = 1;
    string verify_code = 2;
    string password = 3;
    string display_name = 4;      // 可选
}

message RegisterResponse {
    pb_common.Result result = 1;
    UserInfo user = 2;
    TokenPair tokens = 3;
}

// ==================== 登录接口 ====================

message LoginByPasswordRequest {
    string mobile = 1;
    string password = 2;
}

message LoginByPasswordResponse {
    pb_common.Result result = 1;
    UserInfo user = 2;
    TokenPair tokens = 3;
}

message LoginByCodeRequest {
    string mobile = 1;
    string verify_code = 2;
}

message LoginByCodeResponse {
    pb_common.Result result = 1;
    UserInfo user = 2;
    TokenPair tokens = 3;
}

// ==================== Token管理接口 ====================

message RefreshTokenRequest {
    string refresh_token = 1;
}

message RefreshTokenResponse {
    pb_common.Result result = 1;
    TokenPair tokens = 2;
}

message LogoutRequest {
    string refresh_token = 1;
}

message LogoutResponse {
    pb_common.Result result = 1;
}

// ==================== 密码管理接口 ====================

message ResetPasswordRequest {
    string mobile = 1;
    string verify_code = 2;
    string new_password = 3;
}

message ResetPasswordResponse {
    pb_common.Result result = 1;
}

// ==================== 内部服务调用 - Token验证接口 ====================

message ValidateTokenRequest {
    string access_token = 1;
}

message ValidateTokenResponse {
    pb_common.Result result = 1;
    string user_id = 2;                          // 用户数据库ID（内部使用）
    string user_uuid = 3;                        // 用户UUID（对外标识）
    string mobile = 4;                           // 手机号
    UserRole role = 5;                           // 用户角色（新增）
    google.protobuf.Timestamp expires_at = 6;   // 过期时间
}

// ==================== 服务定义 ====================

service AuthService {
    // 验证码
    rpc SendVerifyCode(SendVerifyCodeRequest) returns (SendVerifyCodeResponse);
    
    // 注册
    rpc Register(RegisterRequest) returns (RegisterResponse);
    
    // 登录
    rpc LoginByPassword(LoginByPasswordRequest) returns (LoginByPasswordResponse);
    rpc LoginByCode(LoginByCodeRequest) returns (LoginByCodeResponse);
    
    // Token管理
    rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse);
    rpc Logout(LogoutRequest) returns (LogoutResponse);
    
    // 密码重置
    rpc ResetPassword(ResetPasswordRequest) returns (ResetPasswordResponse);
    
    // 内部服务Token验证（禁止客户端调用）
    rpc ValidateToken(ValidateTokenRequest) returns (ValidateTokenResponse);
}
