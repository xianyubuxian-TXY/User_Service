# Services æ¨¡å— - ä¸šåŠ¡æœåŠ¡å±‚

ç”¨æˆ·æœåŠ¡çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å±‚ï¼ŒåŒ…å«è®¤è¯æœåŠ¡ï¼ˆAuthServiceï¼‰å’Œç”¨æˆ·æœåŠ¡ï¼ˆUserServiceï¼‰ï¼Œæä¾›å®Œæ•´çš„ç”¨æˆ·ç®¡ç†åŠŸèƒ½ã€‚

---

## ğŸ“ ç›®å½•ç»“æ„

```
include/service/
â”œâ”€â”€ auth_service.h        # è®¤è¯æœåŠ¡ï¼ˆæ³¨å†Œã€ç™»å½•ã€Tokenç®¡ç†ï¼‰
â””â”€â”€ user_service.h        # ç”¨æˆ·æœåŠ¡ï¼ˆç”¨æˆ·ä¿¡æ¯ç®¡ç†ï¼‰

src/services/
â”œâ”€â”€ auth_service.cpp
â”œâ”€â”€ user_service.cpp
â””â”€â”€ CMakeLists.txt
```

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           gRPC Handler å±‚                                   â”‚
â”‚                   (AuthHandler / UserHandler)                               â”‚
â”‚                      â†“ è°ƒç”¨ Service å±‚                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           Service å±‚ (æœ¬æ¨¡å—)                                â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚              â”‚   AuthService   â”‚    â”‚   UserService   â”‚                     â”‚
â”‚              â”‚  â€¢ æ³¨å†Œ/ç™»å½•     â”‚    â”‚  â€¢ ç”¨æˆ·ä¿¡æ¯ç®¡ç†  â”‚                     â”‚
â”‚              â”‚  â€¢ Token ç®¡ç†   â”‚    â”‚  â€¢ å¯†ç ä¿®æ”¹      â”‚                     â”‚
â”‚              â”‚  â€¢ å¯†ç é‡ç½®     â”‚    â”‚  â€¢ è´¦å·æ³¨é”€      â”‚                     â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                       â”‚                      â”‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       â–¼                      â–¼                              â”‚
â”‚                     Repository / åŸºç¡€æœåŠ¡å±‚                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚  UserDB  â”‚  â”‚TokenRepo â”‚  â”‚JwtServiceâ”‚  â”‚SmsServiceâ”‚  â”‚RedisClientâ”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æœåŠ¡ä¾èµ–å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AuthService                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¾èµ–:                                                          â”‚
â”‚  â€¢ Config         - å…¨å±€é…ç½®                                    â”‚
â”‚  â€¢ UserDB         - ç”¨æˆ·æ•°æ®åº“æ“ä½œ                              â”‚
â”‚  â€¢ RedisClient    - ç¼“å­˜ï¼ˆç™»å½•å¤±è´¥è®¡æ•°ç­‰ï¼‰                       â”‚
â”‚  â€¢ TokenRepository- Token å­˜å‚¨                                  â”‚
â”‚  â€¢ JwtService     - JWT ç”Ÿæˆ/éªŒè¯                               â”‚
â”‚  â€¢ SmsService     - çŸ­ä¿¡éªŒè¯ç                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        UserService                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¾èµ–:                                                          â”‚
â”‚  â€¢ Config         - å…¨å±€é…ç½®                                    â”‚
â”‚  â€¢ UserDB         - ç”¨æˆ·æ•°æ®åº“æ“ä½œ                              â”‚
â”‚  â€¢ TokenRepository- Token å­˜å‚¨ï¼ˆå¼ºåˆ¶ç™»å‡ºç”¨ï¼‰                     â”‚
â”‚  â€¢ SmsService     - çŸ­ä¿¡éªŒè¯ç ï¼ˆæ³¨é”€è´¦å·éªŒè¯ï¼‰                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” AuthServiceï¼ˆè®¤è¯æœåŠ¡ï¼‰

è´Ÿè´£ç”¨æˆ·èº«ä»½è®¤è¯ç›¸å…³çš„æ‰€æœ‰ä¸šåŠ¡é€»è¾‘ã€‚

### åŠŸèƒ½æ¦‚è§ˆ

| åŠŸèƒ½ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| å‘é€éªŒè¯ç  | `SendVerifyCode` | æ³¨å†Œ/ç™»å½•/é‡ç½®å¯†ç  |
| ç”¨æˆ·æ³¨å†Œ | `Register` | æ‰‹æœºå· + éªŒè¯ç  + å¯†ç  |
| å¯†ç ç™»å½• | `LoginByPassword` | æ‰‹æœºå· + å¯†ç  |
| éªŒè¯ç ç™»å½• | `LoginByCode` | æ‰‹æœºå· + éªŒè¯ç  |
| é‡ç½®å¯†ç  | `ResetPassword` | å¿˜è®°å¯†ç æ—¶ä½¿ç”¨ |
| åˆ·æ–°ä»¤ç‰Œ | `RefreshToken` | ç”¨ refresh_token æ¢æ–°ä»¤ç‰Œå¯¹ |
| ç™»å‡º | `Logout` | å•è®¾å¤‡ç™»å‡º |
| å…¨è®¾å¤‡ç™»å‡º | `LogoutAll` | è¸¢å‡ºæ‰€æœ‰è®¾å¤‡ |
| éªŒè¯ä»¤ç‰Œ | `ValidateAccessToken` | ä¾›å…¶ä»–å¾®æœåŠ¡è°ƒç”¨ |

### æ¥å£å®šä¹‰

```cpp
class AuthService {
public:
    AuthService(std::shared_ptr<Config> config,
                std::shared_ptr<UserDB> user_db,
                std::shared_ptr<RedisClient> redis_cli,
                std::shared_ptr<TokenRepository> token_repo,
                std::shared_ptr<JwtService> jwt_srv,
                std::shared_ptr<SmsService> sms_srv);

    // ==================== éªŒè¯ç  ====================
    /// @brief å‘é€éªŒè¯ç 
    /// @param mobile æ‰‹æœºå·
    /// @param scene åœºæ™¯ï¼šRegister/Login/ResetPassword/DeleteUser
    /// @return æˆåŠŸè¿”å›é‡è¯•é—´éš”ï¼ˆç§’ï¼‰
    Result<int32_t> SendVerifyCode(const std::string& mobile, SmsScene scene);

    // ==================== æ³¨å†Œ ====================
    /// @brief ç”¨æˆ·æ³¨å†Œ
    /// @return æˆåŠŸè¿”å› AuthResultï¼ˆç”¨æˆ·ä¿¡æ¯ + Tokenå¯¹ï¼‰
    Result<AuthResult> Register(const std::string& mobile,
                                const std::string& verify_code,
                                const std::string& password,
                                const std::string& display_name);

    // ==================== ç™»å½• ====================
    Result<AuthResult> LoginByPassword(const std::string& mobile,
                                       const std::string& password);
    
    Result<AuthResult> LoginByCode(const std::string& mobile,
                                   const std::string& verify_code);

    // ==================== å¯†ç ç®¡ç† ====================
    Result<void> ResetPassword(const std::string& mobile,
                               const std::string& verify_code,
                               const std::string& new_password);

    // ==================== Token ç®¡ç† ====================
    Result<TokenPair> RefreshToken(const std::string& refresh_token);
    Result<void> Logout(const std::string& refresh_token);
    Result<void> LogoutAll(const std::string& user_uuid);

    // ==================== å†…éƒ¨éªŒè¯ï¼ˆä¾›å…¶ä»–å¾®æœåŠ¡è°ƒç”¨ï¼‰====================
    Result<TokenValidationResult> ValidateAccessToken(const std::string& access_token);
};
```

### æ ¸å¿ƒæµç¨‹

#### 1. æ³¨å†Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‚æ•°æ ¡éªŒ    â”‚ â”€â”€â–º â”‚ éªŒè¯ç æ ¡éªŒ   â”‚ â”€â”€â–º â”‚ åˆ›å»ºç”¨æˆ·    â”‚ â”€â”€â–º â”‚ ç”ŸæˆToken   â”‚
â”‚ (æ‰‹æœº/å¯†ç ) â”‚     â”‚ (SmsService)â”‚     â”‚ (UserDB)    â”‚     â”‚ (JwtService)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
                    â”‚ è¿”å›ç»“æœ    â”‚ â—„â”€â”€ â”‚ å­˜å‚¨Token   â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ (AuthResult)â”‚     â”‚ (TokenRepo) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. å¯†ç ç™»å½•æµç¨‹ï¼ˆå«é˜²æš´åŠ›ç ´è§£ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‚æ•°æ ¡éªŒ    â”‚ â”€â”€â–º â”‚ æ£€æŸ¥é”å®š    â”‚ â”€â”€â–º â”‚ æŸ¥è¯¢ç”¨æˆ·    â”‚
â”‚             â”‚     â”‚ (Redis)     â”‚     â”‚ (UserDB)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚                                           â”‚
                         â–¼ ç”¨æˆ·å­˜åœ¨                                   â–¼ ç”¨æˆ·ä¸å­˜åœ¨
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ éªŒè¯å¯†ç     â”‚                              â”‚ è®°å½•å¤±è´¥    â”‚
                â”‚ (bcrypt)    â”‚                              â”‚ (Redis)     â”‚
                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                       â”‚                                            â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
         â”‚                           â”‚                              â”‚
         â–¼ å¯†ç æ­£ç¡®                   â–¼ å¯†ç é”™è¯¯                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚ æ¸…é™¤å¤±è´¥è®°å½•â”‚              â”‚ è®°å½•å¤±è´¥    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ (Redis)     â”‚              â”‚ (Redis)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                            â”‚
       â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”ŸæˆToken   â”‚              â”‚ è¿”å›é”™è¯¯    â”‚
â”‚ è¿”å›æˆåŠŸ    â”‚              â”‚ (æ¨¡ç³Šæç¤º)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3. Token åˆ·æ–°æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è§£æToken   â”‚ â”€â”€â–º â”‚ æŸ¥è¯¢ç”¨æˆ·    â”‚ â”€â”€â–º â”‚ æ ¡éªŒToken   â”‚ â”€â”€â–º â”‚ åˆ é™¤æ—§Token â”‚
â”‚ è·å–user_id â”‚     â”‚ æ£€æŸ¥çŠ¶æ€    â”‚     â”‚ æ˜¯å¦æœ‰æ•ˆ    â”‚     â”‚ (TokenRepo) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
                    â”‚ è¿”å›æ–°Token â”‚ â—„â”€â”€ â”‚ ç”Ÿæˆæ–°Token â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ å¯¹          â”‚     â”‚ å­˜å‚¨æ–°Token â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®‰å…¨ç‰¹æ€§

#### ç™»å½•å¤±è´¥é”å®š

```cpp
// é…ç½®é¡¹ (config.yaml)
login:
  max_failed_attempts: 5       # æœ€å¤§å¤±è´¥æ¬¡æ•°
  failed_attempts_window: 900  # è®¡æ•°çª—å£ï¼ˆç§’ï¼‰
  lock_duration_seconds: 1800  # é”å®šæ—¶é•¿ï¼ˆç§’ï¼‰
```

```
å¤±è´¥æ¬¡æ•° Redis Key: login:fail:{mobile}
TTL: é”å®šæ—¶é•¿æˆ–è®¡æ•°çª—å£

ç¬¬1æ¬¡å¤±è´¥ â†’ count=1, TTL=15åˆ†é’Ÿï¼ˆçª—å£æœŸï¼‰
ç¬¬2æ¬¡å¤±è´¥ â†’ count=2, TTLä¸å˜
...
ç¬¬5æ¬¡å¤±è´¥ â†’ count=5, TTL=30åˆ†é’Ÿï¼ˆé”å®šæœŸï¼‰
         â†’ è¿”å› "è´¦å·å·²é”å®šï¼Œè¯·30åˆ†é’Ÿåå†è¯•"
```

#### å¯†ç å®‰å…¨

```cpp
// å¯†ç å“ˆå¸Œå­˜å‚¨
std::string hash = PasswordHelper::Hash(password);
// æ ¼å¼: $sha256$<salt>$<hash>

// å¯†ç éªŒè¯
bool valid = PasswordHelper::Verify(input_password, stored_hash);
```

### ä½¿ç”¨ç¤ºä¾‹

```cpp
#include "service/auth_service.h"

// åˆ›å»ºæœåŠ¡
auto auth_service = std::make_shared<AuthService>(
    config, user_db, redis_client, token_repo, jwt_service, sms_service
);

// 1. å‘é€æ³¨å†ŒéªŒè¯ç 
auto send_result = auth_service->SendVerifyCode("13800138000", SmsScene::Register);
if (send_result.IsOk()) {
    int retry_after = send_result.Value();  // 60ç§’åå¯é‡å‘
}

// 2. ç”¨æˆ·æ³¨å†Œ
auto reg_result = auth_service->Register(
    "13800138000",      // æ‰‹æœºå·
    "123456",           // éªŒè¯ç 
    "MyPassword123",    // å¯†ç 
    "å¼ ä¸‰"              // æ˜µç§°
);
if (reg_result.IsOk()) {
    auto& auth = reg_result.Value();
    auto& user = auth.user;         // ç”¨æˆ·ä¿¡æ¯
    auto& tokens = auth.tokens;     // access_token + refresh_token
}

// 3. å¯†ç ç™»å½•
auto login_result = auth_service->LoginByPassword("13800138000", "MyPassword123");
if (login_result.IsOk()) {
    auto& tokens = login_result.Value().tokens;
    // è¿”å›ç»™å®¢æˆ·ç«¯
}

// 4. åˆ·æ–° Token
auto refresh_result = auth_service->RefreshToken(refresh_token);
if (refresh_result.IsOk()) {
    auto& new_tokens = refresh_result.Value();
}

// 5. ç™»å‡º
auth_service->Logout(refresh_token);
```

---

## ğŸ‘¤ UserServiceï¼ˆç”¨æˆ·æœåŠ¡ï¼‰

è´Ÿè´£ç”¨æˆ·ä¿¡æ¯ç®¡ç†ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ã€‚

### åŠŸèƒ½æ¦‚è§ˆ

| åŠŸèƒ½ | æ–¹æ³• | æƒé™è¦æ±‚ |
|------|------|----------|
| è·å–å½“å‰ç”¨æˆ· | `GetCurrentUser` | å·²ç™»å½•ç”¨æˆ· |
| æ›´æ–°ç”¨æˆ·ä¿¡æ¯ | `UpdateUser` | å·²ç™»å½•ç”¨æˆ· |
| ä¿®æ”¹å¯†ç  | `ChangePassword` | å·²ç™»å½•ç”¨æˆ· |
| æ³¨é”€è´¦å· | `DeleteUser` | å·²ç™»å½•ç”¨æˆ· + éªŒè¯ç  |
| è·å–æŒ‡å®šç”¨æˆ· | `GetUser` | ç®¡ç†å‘˜ |
| ç”¨æˆ·åˆ—è¡¨ | `ListUsers` | ç®¡ç†å‘˜ |
| ç¦ç”¨/å¯ç”¨ç”¨æˆ· | `SetUserDisabled` | ç®¡ç†å‘˜ |

### æ¥å£å®šä¹‰

```cpp
class UserService {
public:
    UserService(std::shared_ptr<Config> config,
                std::shared_ptr<UserDB> user_db,
                std::shared_ptr<TokenRepository> token_repo,
                std::shared_ptr<SmsService> sms_srv);

    // ==================== å½“å‰ç”¨æˆ·æ“ä½œ ====================
    
    /// @brief è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
    /// @param user_uuid ä» Access Token è§£æ
    Result<UserEntity> GetCurrentUser(const std::string& user_uuid);
    
    /// @brief æ›´æ–°ç”¨æˆ·ä¿¡æ¯
    /// @param display_name å¯é€‰ï¼Œæ˜µç§°
    Result<UserEntity> UpdateUser(const std::string& user_uuid,
                                  std::optional<std::string> display_name);
    
    /// @brief ä¿®æ”¹å¯†ç ï¼ˆéœ€è¦æ—§å¯†ç éªŒè¯ï¼‰
    Result<void> ChangePassword(const std::string& user_uuid,
                                const std::string& old_password,
                                const std::string& new_password);
    
    /// @brief æ³¨é”€è´¦å·ï¼ˆéœ€è¦éªŒè¯ç ç¡®è®¤ï¼‰
    Result<void> DeleteUser(const std::string& user_uuid,
                            const std::string verify_code);

    // ==================== ç®¡ç†å‘˜æ“ä½œ ====================
    
    /// @brief è·å–æŒ‡å®šç”¨æˆ·
    Result<UserEntity> GetUser(const std::string& user_uuid);
    
    /// @brief åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
    /// @param mobile_filter æ‰‹æœºå·æ¨¡ç³Šç­›é€‰
    /// @param disabled_filter ç¦ç”¨çŠ¶æ€ç­›é€‰
    Result<ListUsersResult> ListUsers(std::optional<std::string> mobile_filter,
                                      std::optional<bool> disabled_filter,
                                      int32_t page = 1,
                                      int32_t page_size = 20);
    
    /// @brief ç¦ç”¨/å¯ç”¨ç”¨æˆ·
    Result<void> SetUserDisabled(const std::string& user_uuid, bool disabled);
};
```

### æ ¸å¿ƒæµç¨‹

#### 1. ä¿®æ”¹å¯†ç æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‚æ•°æ ¡éªŒ    â”‚ â”€â”€â–º â”‚ æŸ¥è¯¢ç”¨æˆ·    â”‚ â”€â”€â–º â”‚ éªŒè¯æ—§å¯†ç   â”‚ â”€â”€â–º â”‚ æ›´æ–°å¯†ç     â”‚
â”‚ (æ–°æ—§å¯†ç )  â”‚     â”‚ (UserDB)    â”‚     â”‚ (bcrypt)    â”‚     â”‚ (UserDB)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. æ³¨é”€è´¦å·æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‚æ•°æ ¡éªŒ    â”‚ â”€â”€â–º â”‚ æŸ¥è¯¢ç”¨æˆ·    â”‚ â”€â”€â–º â”‚ éªŒè¯ç æ ¡éªŒ  â”‚ â”€â”€â–º â”‚ åˆ é™¤Token   â”‚
â”‚             â”‚     â”‚ è·å–æ‰‹æœºå·  â”‚     â”‚ (SmsService)â”‚     â”‚ (å¼ºåˆ¶ç™»å‡º)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
                    â”‚ è½¯åˆ é™¤ç”¨æˆ·  â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ disabled=1  â”‚
                    â”‚ é‡Šæ”¾æ‰‹æœºå·  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3. ç¦ç”¨ç”¨æˆ·æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æƒé™æ£€æŸ¥    â”‚ â”€â”€â–º â”‚ æŸ¥è¯¢ç”¨æˆ·    â”‚ â”€â”€â–º â”‚ æ›´æ–°çŠ¶æ€    â”‚ â”€â”€â–º â”‚ åˆ é™¤Token   â”‚
â”‚ (ç®¡ç†å‘˜)    â”‚     â”‚ (UserDB)    â”‚     â”‚ disabled=1  â”‚     â”‚ (å¼ºåˆ¶ç™»å‡º)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä½¿ç”¨ç¤ºä¾‹

```cpp
#include "service/user_service.h"

// åˆ›å»ºæœåŠ¡
auto user_service = std::make_shared<UserService>(
    config, user_db, token_repo, sms_service
);

// 1. è·å–å½“å‰ç”¨æˆ·ï¼ˆuser_uuid ä» Token ä¸­è§£æï¼‰
auto user_result = user_service->GetCurrentUser(user_uuid);
if (user_result.IsOk()) {
    auto& user = user_result.Value();
    // user.uuid, user.mobile, user.display_name...
}

// 2. æ›´æ–°æ˜µç§°
auto update_result = user_service->UpdateUser(
    user_uuid, 
    std::make_optional("æ–°æ˜µç§°")
);

// 3. ä¿®æ”¹å¯†ç 
auto pwd_result = user_service->ChangePassword(
    user_uuid,
    "OldPassword123",
    "NewPassword456"
);
if (!pwd_result.IsOk()) {
    if (pwd_result.code == ErrorCode::WrongPassword) {
        // æ—§å¯†ç é”™è¯¯
    }
}

// 4. æ³¨é”€è´¦å·ï¼ˆéœ€è¦å…ˆå‘é€éªŒè¯ç ï¼‰
auth_service->SendVerifyCode(mobile, SmsScene::DeleteUser);
auto delete_result = user_service->DeleteUser(user_uuid, "123456");

// 5. ç®¡ç†å‘˜ï¼šæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
auto list_result = user_service->ListUsers(
    std::make_optional("138"),      // æ‰‹æœºå·åŒ…å« 138
    std::make_optional(false),      // åªæŸ¥æœªç¦ç”¨çš„
    1,                              // ç¬¬1é¡µ
    20                              // æ¯é¡µ20æ¡
);
if (list_result.IsOk()) {
    auto& result = list_result.Value();
    for (auto& user : result.users) {
        // å¤„ç†ç”¨æˆ·
    }
    auto& page = result.page_res;
    // page.total_records, page.total_pages...
}

// 6. ç®¡ç†å‘˜ï¼šç¦ç”¨ç”¨æˆ·
user_service->SetUserDisabled(target_user_uuid, true);
```

---

## ğŸ“¦ è¿”å›å€¼ç±»å‹

### AuthResult

```cpp
struct AuthResult {
    UserEntity user;    // ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸å«å¯†ç ï¼‰
    TokenPair tokens;   // access_token + refresh_token + expires_in
};
```

### ListUsersResult

```cpp
struct ListUsersResult {
    std::vector<UserEntity> users;  // ç”¨æˆ·åˆ—è¡¨
    PageResult page_res;            // åˆ†é¡µä¿¡æ¯
};

struct PageResult {
    int total_records;  // æ€»è®°å½•æ•°
    int total_pages;    // æ€»é¡µæ•°
    int page;           // å½“å‰é¡µ
    int page_size;      // æ¯é¡µå¤§å°
};
```

### TokenValidationResult

```cpp
struct TokenValidationResult {
    int64_t user_id;        // æ•°æ®åº“ç”¨æˆ·ID
    std::string user_uuid;  // ç”¨æˆ· UUID
    std::string mobile;     // æ‰‹æœºå·
    UserRole role;          // ç”¨æˆ·è§’è‰²
    std::chrono::system_clock::time_point expires_at;
};
```

---

## ğŸ”‘ ç”¨æˆ·è§’è‰²

```cpp
enum class UserRole {
    User = 0,           // æ™®é€šç”¨æˆ·
    Admin = 1,          // ç®¡ç†å‘˜
    SuperAdmin = 2      // è¶…çº§ç®¡ç†å‘˜
};
```

### æƒé™çŸ©é˜µ

| æ¥å£ | User | Admin | SuperAdmin |
|------|:----:|:-----:|:----------:|
| GetCurrentUser | âœ… | âœ… | âœ… |
| UpdateUser | âœ… | âœ… | âœ… |
| ChangePassword | âœ… | âœ… | âœ… |
| DeleteUser | âœ… | âœ… | âœ… |
| GetUser | âŒ | âœ… | âœ… |
| ListUsers | âŒ | âœ… | âœ… |
| SetUserDisabled | âŒ | âœ… | âœ… |

---

## âš™ï¸ é…ç½®è¯´æ˜

### ç™»å½•å®‰å…¨é…ç½®

```yaml
login:
  max_failed_attempts: 5       # æœ€å¤§ç™»å½•å¤±è´¥æ¬¡æ•°
  failed_attempts_window: 900  # å¤±è´¥è®¡æ•°çª—å£ï¼ˆç§’ï¼‰
  lock_duration_seconds: 1800  # é”å®šæ—¶é•¿ï¼ˆç§’ï¼‰
  max_sessions_per_user: 5     # å•ç”¨æˆ·æœ€å¤§ä¼šè¯æ•°
  kick_oldest_session: true    # è¶…å‡ºæ—¶è¸¢æ‰æœ€æ—§ä¼šè¯
```

### å¯†ç ç­–ç•¥é…ç½®

```yaml
password:
  min_length: 8                # æœ€å°é•¿åº¦
  max_length: 32               # æœ€å¤§é•¿åº¦
  require_uppercase: false     # éœ€è¦å¤§å†™å­—æ¯
  require_lowercase: false     # éœ€è¦å°å†™å­—æ¯
  require_digit: true          # éœ€è¦æ•°å­—
  require_special_char: false  # éœ€è¦ç‰¹æ®Šå­—ç¬¦
```

### éªŒè¯ç é…ç½®

```yaml
sms:
  code_len: 6                  # éªŒè¯ç é•¿åº¦
  code_ttl_seconds: 300        # æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰
  send_interval_seconds: 60    # å‘é€é—´éš”ï¼ˆç§’ï¼‰
  max_retry_count: 5           # æœ€å¤§éªŒè¯é”™è¯¯æ¬¡æ•°
  lock_seconds: 1800           # é”å®šæ—¶é•¿ï¼ˆç§’ï¼‰
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å¯†ç å®‰å…¨
- æ°¸è¿œä¸è¦åœ¨æ—¥å¿—ä¸­æ‰“å°å¯†ç 
- è¿”å›ç»™å®¢æˆ·ç«¯çš„ UserEntity å¿…é¡»æ¸…ç©º `password_hash`
- ç™»å½•å¤±è´¥è¿”å›æ¨¡ç³Šæç¤ºï¼ˆ"è´¦å·æˆ–å¯†ç é”™è¯¯"ï¼‰ï¼Œä¸è¦æš´éœ²ç”¨æˆ·æ˜¯å¦å­˜åœ¨

### 2. Token å®‰å…¨
- Refresh Token å­˜å‚¨å“ˆå¸Œå€¼ï¼Œä¸å­˜æ˜æ–‡
- ç”¨æˆ·ç¦ç”¨/æ³¨é”€æ—¶ç«‹å³åˆ é™¤æ‰€æœ‰ Token
- Access Token çŸ­æœ‰æ•ˆæœŸï¼ˆ15åˆ†é’Ÿï¼‰ï¼ŒRefresh Token é•¿æœ‰æ•ˆæœŸï¼ˆ7å¤©ï¼‰

### 3. äº‹åŠ¡ä¸€è‡´æ€§
- æ³¨å†ŒæˆåŠŸåæ‰å‘ Token
- Token åˆ·æ–°æ—¶å…ˆåˆ æ—§å†å­˜æ–°
- æ³¨é”€è´¦å·æ—¶å…ˆåˆ  Token å†æ”¹ç”¨æˆ·çŠ¶æ€

### 4. æ¥å£å¹‚ç­‰æ€§
- `Logout` å¹‚ç­‰ï¼šé‡å¤è°ƒç”¨ä¸æŠ¥é”™
- `DeleteUser` éå¹‚ç­‰ï¼šéœ€è¦éªŒè¯ç é˜²æ­¢è¯¯æ“ä½œ

---

## ğŸ“š ç›¸å…³æ¨¡å—

| æ¨¡å— | è¯´æ˜ |
|------|------|
| `auth/jwt_service` | JWT ç”Ÿæˆä¸éªŒè¯ |
| `auth/sms_service` | çŸ­ä¿¡éªŒè¯ç  |
| `auth/token_repository` | Token æ•°æ®åº“å­˜å‚¨ |
| `db/user_db` | ç”¨æˆ·æ•°æ®åº“æ“ä½œ |
| `cache/redis_client` | Redis ç¼“å­˜ |
| `handlers/auth_handler` | gRPC è®¤è¯æ¥å£ |
| `handlers/user_handler` | gRPC ç”¨æˆ·æ¥å£ |

